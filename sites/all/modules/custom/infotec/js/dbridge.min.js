/*!
 * dbridge.min.js -- v1.0.0 -- 3/8/2015
 * Copyright (c) 2015 ECPI University; Licensed Proprietary
 */
;if(typeof jQuery==="undefined"){throw new Error("dbridge.min.js script requires jQuery")}var dbError=1,dbWarn=2,dbInfo=3,cObj,sObj,secObj=[],cform,activeSection="Courses",config={pathUrl:location.protocol+"//"+location.hostname+"/",debug:true};setUpConsole();function Selector(a){var b=this,c=jQuery;b.id=a;b.obj=c("#"+a);b.rState=false;b.getId=function(){return(b.id)};b.getObj=function(){return(b.obj)};b.getRstate=function(){return(b.rState)};b.setRstate=function(d){b.rState=d};b.enable=function(){b.getObj().prop("disabled",false);debug(dbInfo,"==> "+b.getId()+" is enabled")};b.disable=function(){b.getObj().prop("disabled",true);b.getObj().val("");debug(dbInfo,"==> "+b.getId()+" is disabled")};b.setAttr=function(d,e){b.getObj().prop(d,e)}}function DDHandler(c,b,d){var a,f=this,e=jQuery;f.collection_2=[];f.collection_3=[];f.jQLevel_1=new Selector(c);f.jQLevel_2=new Selector(b);f.jQLevel_3=new Selector(d);f.jQLevel_2.setRstate(true);f.jQLevel_3.setRstate(true);f._rebuildList=function(g,h){for(f.iter=0;f.iter<g.length;f.iter++){h.append(g[f.iter])}debug(dbInfo,"added "+(g.length+1)+" options")};f._filterList=function(i,h){var g=0;h.children("option").each(function(){if(!e(this).hasClass(i)&&e(this).val()!=""){e(this).detach();g++}});debug(dbInfo,"removed "+(g+1)+" options")};f.rebuildLevel_2=function(){if(true===f.jQLevel_2.getRstate()){f._rebuildList(f.collection_2,f.jQLevel_2.getObj());f.jQLevel_2.setRstate(false);f.jQLevel_2.disable();debug(dbInfo,">> level-2 rebuilt")}};f.rebuildLevel_3=function(){if(true===f.jQLevel_3.getRstate()){f._rebuildList(f.collection_3,f.jQLevel_3.getObj());f.jQLevel_3.setRstate(false);f.jQLevel_3.disable();debug(dbInfo,">> level-3 rebuilt")}};f.rebuildAll=function(){f.rebuildLevel_2();f.rebuildLevel_3()};f.filterLevel_2=function(g){debug(dbInfo,"* level-2 filtering for "+g);f._filterList(g,f.jQLevel_2.getObj());f.jQLevel_2.setRstate(true);f.jQLevel_2.enable()};f.filterLevel_3=function(g){debug(dbInfo,"* level-3 filtering for "+g);f._filterList(g,f.jQLevel_3.getObj());f.jQLevel_3.setRstate(true);f.jQLevel_3.enable()};f.init=function(i,g,j){var k=jQuery;k(i).appendTo(f.jQLevel_1.getObj());k(g).appendTo(f.jQLevel_2.getObj());k(j).appendTo(f.jQLevel_3.getObj());var h=[];h=f.jQLevel_2.getObj().children("option");for(f.iter=0;f.iter<h.length;f.iter++){f.collection_2.push(k(h[f.iter]).detach())}h=f.jQLevel_3.getObj().children("option");for(f.iter=0;f.iter<h.length;f.iter++){f.collection_3.push(k(h[f.iter]).detach())}f.rebuildAll();k("#"+f.jQLevel_2.getId()).on("change",function(m){var n=k(this).is(":focus");if(n){m.stopImmediatePropagation();var l=k(this).val();debug(dbInfo,"--> Level-2 change to: "+((l!="")?l:"no selection"));debug(dbInfo," ---> rebuilding level 3");f.rebuildLevel_3();if(""!=l){f.filterLevel_3(l)}return false}});k("#"+f.jQLevel_1.getId()).on("change",function(m){var n=k(this).is(":focus");if(n){m.stopImmediatePropagation();var l=k(this).val();debug(dbInfo,"--> Level-1 change to: "+((l!="")?l:"no selection"));debug(dbInfo," ---> rebuilding all levels");f.rebuildAll();if(""!=l){f.filterLevel_2(l)}return false}});k("#"+f.jQLevel_1.getId()).on("activate",function(l){k(this).val("");f.jQLevel_1.enable();debug(dbInfo," ---> "+f.jQLevel_1.getId()+" activated");return false});k("#"+f.jQLevel_1.getId()).on("deactivate",function(l){debug(dbInfo,"active section: "+window.activeSection);if(window.activeSection!="Courses"){k(this).val("");f.jQLevel_1.disable();f.jQLevel_2.disable();f.jQLevel_3.disable();debug(dbInfo," ---> "+f.jQLevel_1.getId()+" deactivated");return false}else{debug(dbInfo,"[ ignoring deactivate event ] ")}})}}function Section(a,b,e){var c=this,d=jQuery;c.others=b;c.jQo=a;c.id=d(a).attr("id");c.isOpen=e;c.controls=d("#"+c.id+"> *").find("select, input, textarea");c.open=function(){c.enableControls();d(c.jQo).fadeIn(1200,function(){c.isOpen=true;window.activeSection=c.id;debug(dbInfo,"Section "+c.id+" open")});c.closeOpenSection()};c.close=function(){d(c.jQo).fadeOut(1200,function(){c.isOpen=false;c.disableControls();debug(dbInfo,"Section "+c.id+" closed")})};c.disableControls=function(){if(c.controls.length>0){d(c.controls).each(function(){d(this).trigger("deactivate");debug(dbInfo,"<< sent deactivate event: "+d(this).attr("name"))})}};c.enableControls=function(){if(c.controls.length>0){d(c.controls).each(function(){d(this).trigger("activate");debug(dbInfo,"<< sent activate event: "+d(this).attr("name"))})}};c.closeOpenSection=function(){if(c.others.length>0){d.each(c.others,function(){d(this).trigger("closeSection");debug(dbInfo,"<< sent closeSection event")})}};d(c.jQo).on("openSection",function(f){if(!c.isOpen){c.open()}});d(c.jQo).on("closeSection",function(f){if(c.isOpen){c.close()}});if(!c.isOpen){d(c.jQo).hide();c.disableControls()}else{c.open();c.enableControls()}}function FormHandler(b){var a=this,c=jQuery;a.id=b;a.fields=null;a.errorClass="cf-error";a.errors=0;a.clearErrors=function(){c("."+a.errorClass).each(function(){c(this).removeClass(a.errorClass)});debug(dbInfo,"all errors cleared");a.errors=0};a.markError=function(d){c("#"+d).addClass(a.errorClass);debug(dbInfo,"invalid field: "+d);a.errors+=1};a.unMarkError=function(d){c("#"+d).removeClass(a.errorClass);a.errors=(a.errors>0)?a.errors-1:0;debug(dbInfo,"--> error cleared for "+d)};a.validate=function(j){var q={field:{name:null,value:[],label:null,order:null,type:null,req:0}},h=[],n=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,f=/^[a-zA-Z]+$/,p=/^[a-zA-Z-]+$/,m=/^\s*[0-9a-zA-Z][0-9a-zA-Z'-@]*$/,d=/^(?:\([2-9]\d{2}\)\ ?|[2-9]\d{2}(?:\-?|\ ?))[2-9]\d{2}[- ]?\d{4}/,o=/^\d{5}(-\d{4})?$/,e=function(t,s){return(s.test(t))},g=function(s){return(!s||/^\s*$/.test(s))},l=function(s){return(e(s,p))},k=function(s){return(e(s,n))},r=function(s){return(e(s,d))},i=function(s){return(e(s,o))};c.each(j,function(w,y){var s="#"+y.name,v=g(y.value),u=(c(s).prop("required")==true),x=c(s).data("type"),z=c(s).data("label"),t=c(s).data("order"),A=0;if(u&&!v){switch(x){case"mselect":if(!q.field.name){q.field.name=y.name;q.field.value.push(y.value);q.field.label=z;q.field.order=t;q.field.type=x;q.field.req=u;A=1}else{if(q.field.name==y.name){q.field.value.push(y.value);A=1}}break;case"name":if(!l(y.value)){a.markError(y.name)}break;case"email":if(!k(y.value)){a.markError(y.name)}break;case"tel":if(!r(y.value)){a.markError(y.name)}break;default:break}}else{if(u){a.markError(y.name)}}if(!A){h.push({name:y.name,value:y.value,label:z,order:t,type:x,req:u})}});if(q.field.name!=null){h.push({name:q.field.name,value:q.field.value,label:q.field.label,order:q.field.order,req:q.req})}a.fields=h};a.submit=function(){a.clearErrors();a.fields=c(a.id).serializeArray();a.validate(a.fields);a.fields=((!a.errors)?a.fields:[]);debug(dbInfo,"submission error count: "+a.errors);return(a.errors)};a.getFields=function(){return(a.fields)}}(function(c,b,d){var a={bridge:{initialized:false,url:"",token:0,data:null,handshake:function(f){if(!this.initialized){debug(dbInfo,"getting bridge token");var e={fid:f};a.bridge.url=b.config.pathUrl;a.bridge.send("hello",e,a.bridge.complete)}},complete:function(f,g){if(typeof f!="undefined"){a.bridge.token=f.token;var h="sform"==g.fid?"sfOptionsFormat":"cfOptionsFormat",e={dman:h,sql:"courseList"};a.bridge.send("bridgeSql",e,("sform"==g.fid?a.bridge.sfInitForm:a.bridge.cfInitForm))}},sfInitForm:function(e,f){if(typeof e!="undefined"){b.sObj=new DDHandler("category","group","course").init(e.list.groups,e.list.subgroups,e.list.courses);c("body").on("click","#course-select",function(){if(""!=c("#category").val()&&""!=c("#group").val()&&""!=c("#course").val()){b.location.href=c("#course").val()}return(false)})}},cfInitForm:function(j,k){if(typeof j!="undefined"){b.cObj=new DDHandler("cf-category","cf-group","cf-course").init(j.list.groups,j.list.subgroups,j.list.courses);var l=[],f,g=c(".form-section");if(g.length>0){c(g).each(function(){l.push(c(this))});var i,e,h;for(f=0;f<l.length;f++){i=l[f];e=l.slice(0);e.splice(f,1);b.secObj.push(new Section(i,e,0))}}b.cform=new FormHandler("#contact-form");c('<div id="pb-wrap"><div id="pb"></div></div><div id="msgBox"></div>').insertBefore("#contact-form");c("body").on("change","#cf-interest",function(){var m=c(this).val();m=(""==m)?"default":m;c("#"+m).trigger("openSection");c.when(c("#"+m).trigger("deactivate")).done(function(){b.cform.clearErrors()})}).on("click","#submit-contact-form",function(n){n.stopPropagation();if(b.cform.submit()){return(false)}else{c("#submit-contact-form").prop("disabled",true);var m=b.cform.getFields();if(m.length>0){a.showProgressBar();a.bridge.send("export",m,a.bridge.formSent)}else{throw Error("empty form fields")}}});c(":input:enabled:visible:not([readonly]):first").focus()}},formSent:function(e){setTimeout(function(){c("#pb-wrap").dialog("close");if(typeof e.err!="undefined"){a.openMsgBox(e.err)}else{if(typeof e.url!="undefined"){b.location.href=e.url}}},10000)},send:function(e,f,g){debug(dbInfo,"url: "+a.bridge.url+"--> action: "+e+", token:"+a.bridge.token+", param: "+JSON.stringify(f));c.ajax({type:"POST",dataType:"json",async:true,url:a.bridge.url,data:{bridge:e,token:a.bridge.token,q:f},success:function(h){if(typeof h!="undefined"){if(h.rc==0){debug(dbInfo,"response: "+JSON.stringify(h));g(h,f)}else{if(h.rc==1){debug(dbInfo,"error: "+JSON.stringify(h));throw new Error("response error from request.")}}}},error:function(i,j,h){debug(dbError,"server response error: "+j);throw new Error("ajax error from request.")}})}},openMsgBox:function(g){var f,e="<ul>";for(f=0;f<g.length;f++){e+="<li>"+g[f]+"</li>"}e+="</ul>";c("#msgBox").html(e).dialog({buttons:[{text:"OK",click:function(){c(this).dialog("close")}}],title:"Form Errors",autoOpen:true,resizable:false,modal:true,hide:"blind",show:"blind",width:500});c("#submit-contact-form").prop("disabled",false)},clookUp:{init:function(){c.get(b.config.pathUrl+"sites/all/modules/custom/infotec/js/courseLookUp.html",function(e){c(e).appendTo("body");a.bridge.handshake(c("#short-form #fid").val());c("#dialog-form").dialog({autoOpen:false,resizable:false,modal:true,hide:"blind",show:"blind",width:375})});c("body").on("click","a.course-lookup",function(){c("#dialog-form").dialog("open");return(false)})}},showProgressBar:function(){c("html, body").animate({scrollTop:"10px"},300,"swing",function(){c("#pb-wrap").dialog({dialogClass:"no-close",height:100,width:300,modal:true,hide:"blind",show:"blind",resizeable:false,autoOpen:false,closeOnEscape:false,title:"Please Wait...",position:{my:"center",at:"center"}});c("#pb").progressbar({value:false}).css({"background-color":"#ccc"});c("#pb-wrap .ui-button .ui-dialog-titlebar-close").css({display:"none"});c("#pb-wrap").dialog("open")})}};c(document).ready(function(h){var j=h("#short-form"),i=h("#contact-form"),e=h("a.course-lookup"),g=b.location.href.indexOf("/admin/")!=-1?1:0,f=h("body").hasClass("front")?1:0;if(i.length>0){debug(dbInfo,"-- form: contact-form detected");a.bridge.handshake(h("#contact-form #fid").val())}if(j.length>0){debug(dbInfo,"-- form: short-form detected");a.bridge.handshake(h("#short-form #fid").val())}if(e.length>0&&!f){debug(dbInfo,"-- course lookup detected");a.clookUp.init()}})}(jQuery,window,"undefined"));function setUpConsole(){if(!window.console){window.console={log:function(){}}}console.log=console.log||function(a){noop()};console.warn=console.warn||function(a){noop()};console.error=console.error||function(a){noop()};console.info=console.info||function(a){noop()}}function noop(){}function debug(a,b){if(config.debug){if(a==dbError){console.error(b)}else{if(a==dbWarn){console.warn(b)}else{if(a==dbInfo){console.info(b)}else{debug(dbInfo,b)}}}}};